{% extends 'fuel_home.html' %}
{% block fuel %}
{% load static %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="{% static 'OlaMapsWebSDKNew/olamaps-web-sdk.umd.js' %}"></script>

<style>
    body {
        background: radial-gradient(circle, rgb(248, 247, 247) 0%, rgb(76, 76, 77) 100%);
    }
    .request-card {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s ease;
        margin-bottom: 25px;
    }
    .request-card:hover {
        transform: translateY(-5px);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eaeaea;
    }
    .map-container {
        height: 300px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .user-info {
        display: flex;
        align-items: center;
    }
    .user-avatar {
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        display: inline-block;
    }
    .status-pending {
        background-color: #ffc107;
        color: #212529;
    }
    .status-confirmed {
        background-color: #17a2b8;
        color: #fff;
    }
    .status-delivery {
        background-color: #fd7e14;
        color: #fff;
    }
    .status-completed {
        background-color: #28a745;
        color: #fff;
    }
    .status-payment {
        background-color: #6f42c1;
        color: #fff;
    }
    .btn-action {
        border-radius: 8px;
        font-weight: 500;
        padding: 8px 16px;
    }
    .progress-tracker {
        display: flex;
        justify-content: space-between;
        margin: 30px 0;
        position: relative;
    }
    .progress-tracker::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: #e9ecef;
        z-index: 0;
    }
    .progress-step {
        position: relative;
        z-index: 1;
        text-align: center;
        width: 20%;
    }
    .step-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        color: #6c757d;
    }
    .step-active .step-icon {
        background-color: #0d6efd;
        color: #fff;
    }
    .step-completed .step-icon {
        background-color: #28a745;
        color: #fff;
    }
    .step-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .step-active .step-label {
        color: #0d6efd;
        font-weight: 600;
    }
    .step-completed .step-label {
        color: #28a745;
        font-weight: 600;
    }
    .fuel-details {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .section-title {
        position: relative;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 3px;
        background-color: #0d6efd;
    }
</style>

<div class="container mt-5">
    <div class="card border-0 shadow-sm bg-white bg-opacity-95 mb-5">
        <div class="card-body p-4">
            <h1 class="text-center mb-4">Fuel Delivery Requests</h1>
            
            <div class="row mt-4">
                {% for request in requests %}
                    <div class="col-lg-12">
                        <div class="request-card">
                            <div class="card-header p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="user-info">
                                        <img src="{{ request.user.profile_pic.url }}" class="user-avatar me-3" alt="{{ request.user.name }}" height="60" width="60">
                                        <div>
                                            <h5 class="mb-0">{{ request.user.name }}</h5>
                                            <div class="text-muted small">
                                                <i class="bi bi-telephone me-1"></i> +91 {{ request.phone }}
                                            </div>
                                            <div class="text-muted small">
                                                <i class="bi bi-calendar me-1"></i> {{ request.datetime|date:"M d, Y - g:i A" }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex flex-column align-items-end">
                                        {% if request.status == 'completed' %}
                                            <span class="status-badge status-completed mb-2">
                                                <i class="bi bi-check-circle me-1"></i> Completed
                                            </span>
                                        {% elif request.status == 'Payment Pending' %}
                                            <span class="status-badge status-payment mb-2">
                                                <i class="bi bi-credit-card me-1"></i> Payment Pending
                                            </span>
                                        {% elif request.status == 'OrderConfirmed' %}
                                            <span class="status-badge status-confirmed mb-2">
                                                <i class="bi bi-bag-check me-1"></i> Order Confirmed
                                            </span>
                                        {% elif request.status == 'Out For Delivery' %}
                                            <span class="status-badge status-delivery mb-2">
                                                <i class="bi bi-truck me-1"></i> Out For Delivery
                                            </span>
                                        {% elif request.status == 'pending' %}
                                            <span class="status-badge status-pending mb-2">
                                                <i class="bi bi-hourglass-split me-1"></i> Pending
                                            </span>
                                       
                                        {% else  %}
                                            <span class="status-badge  mb-2" style="background-color:red;">
                                                <i class="bi bi-hourglass-split me-1"></i> Cancelled

                                            </span>
                                        {% endif %}
                                        
                                        <div>
                                            <span class="text-muted small">Request ID: #{{ request.id }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body p-4">
                                <!-- Progress Tracker -->
                                {% if not request.status == 'Cancelled' %}
                                <div class="progress-tracker">
                                    <div class="progress-step {% if request.status != 'pending' %}step-completed{% else %}step-active{% endif %}">
                                        <div class="step-icon">
                                            <i class="bi bi-1-circle"></i>
                                        </div>
                                        <div class="step-label">Pending</div>
                                    </div>
                                    <div class="progress-step {% if request.status == 'Order Confirmed' or request.status == 'Out For Delivery' or request.status == 'Payment Pending' or request.status == 'completed' %}step-completed{% elif request.status == 'pending' %}{% else %}step-active{% endif %}">
                                        <div class="step-icon">
                                            <i class="bi bi-2-circle"></i>
                                        </div>
                                        <div class="step-label">Confirmed</div>
                                    </div>
                                    <div class="progress-step {% if request.status == 'Out For Delivery' or request.status == 'Payment Pending' or request.status == 'completed' %}step-completed{% elif request.status == 'Order Confirmed' %}step-active{% endif %}">
                                        <div class="step-icon">
                                            <i class="bi bi-3-circle"></i>
                                        </div>
                                        <div class="step-label">Out For Delivery</div>
                                    </div>
                                    <div class="progress-step {% if request.status == 'Payment Pending' or request.status == 'completed' %}step-completed{% elif request.status == 'Out For Delivery' %}step-active{% endif %}">
                                        <div class="step-icon">
                                            <i class="bi bi-4-circle"></i>
                                        </div>
                                        <div class="step-label">Payment</div>
                                    </div>
                                    <div class="progress-step {% if request.status == 'completed' %}step-completed{% elif request.status == 'Payment Pending' %}step-active{% endif %}">
                                        <div class="step-icon">
                                            <i class="bi bi-5-circle"></i>
                                        </div>
                                        <div class="step-label">Completed</div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="progress-tracker">
                                  
                                    <div class="progress-step ">
                                        <div class="step-icon" style="background-color:red;">
                                            <i class="bi bi-1-circle"></i>
                                        </div>
                                        <div class="step-label">Cancelled</div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="row">
                                    <div class="col-md-5">
                                        <h5 class="section-title">Fuel Details</h5>
                                        <div class="fuel-details">
                                            <div class="d-flex justify-content-between mb-3">
                                                <span><i class="bi bi-fuel-pump me-2"></i>Fuel Type:</span>
                                                <span class="fw-bold">{{ request.fuel.fuel_type }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-3">
                                                <span><i class="bi bi-droplet me-2"></i>Quantity:</span>
                                                <span class="fw-bold">{{ request.quantity }} liters</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span><i class="bi bi-geo-alt me-2"></i>Delivery Location:</span>
                                                <span class="fw-bold">{{ request.address|truncatechars:25 }}</span>
                                            </div>
                                        </div>
                                        
                                        <h5 class="section-title">Update Status</h5>
                                        <div class="d-grid gap-2">
                                            {% if request.status == 'pending' %}
                                                <form action="{% url 'update_fuel_request' request.id %}?status=OrderConfirmed" method="post">
                                                    {% csrf_token %}
                                                    {{from.errors}}
                                                    <button type="submit" class="btn btn-primary btn-action w-100 mb-2">
                                                        <i class="bi bi-check2-circle me-2"></i>Confirm Order
                                                    </button>
                                                </form>
                                            {% elif request.status == 'OrderConfirmed' %}
                                                <form action="{% url 'update_fuel_request' request.id %}?status=Out For Delivery" method="post">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-warning btn-action w-100 mb-2 text-white">
                                                        <i class="bi bi-truck me-2"></i>Mark as Out for Delivery
                                                    </button>
                                                </form>
                                            {% elif request.status == 'Out For Delivery' %}
                                                <form action="{% url 'update_fuel_request' request.id %}?status=Payment Pending" method="post">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-info btn-action w-100 mb-2 text-white">
                                                        <i class="bi bi-credit-card me-2"></i>Delivered, Pending Payment
                                                    </button>
                                                </form>
                                            {% elif request.status == 'Payment Pending' %}
                                                <form action="{% url 'update_fuel_request' request.id %}?status=completed" method="post">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-success btn-action w-100 mb-2">
                                                        <i class="bi bi-check2-all me-2"></i>Mark as Completed
                                                    </button>
                                                </form>
                                            {% endif %}
                                            
                                            {% if not request.billfuel_set.exists and request.status != 'pending' and request.status != 'Cancelled' %}
                                                <form action="{% url 'create_bill_payment' request.id %}" method="post">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-outline-primary btn-action w-100">
                                                        <i class="bi bi-receipt me-2"></i>Create Bill
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-7">
                                        <h5 class="section-title">Delivery Location</h5>
                                        <a href="{{ request.link }}" target="_blank" class="text-decoration-none">
                                            <div class="map-container" id="map-{{ forloop.counter }}"></div>
                                        </a>
                                        <div class="text-end mt-2">
                                            <a href="{{ request.link }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-box-arrow-up-right me-1"></i>Open in Maps
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h3 class="mt-3">No Fuel Requests</h3>
                        <p class="text-muted">There are no pending fuel delivery requests at the moment.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if messages %}
            {% for message in messages %}
                alert('{{ message }}');
            {% endfor %}
        {% endif %}
        
        // Initialize maps
        {% for request in requests %}
            if (typeof OlaMaps !== "undefined") {
                const olaMaps = new OlaMaps({ apiKey: "QbmHqKOlHMQTAeKvQIMk4urmtZBSY39Rf5X34TPE" });
                const mapContainerId = "map-{{ forloop.counter }}";
                const latitude = {{ request.latitude|default:0 }};
                const longitude = {{ request.longitude|default:0 }};
                
                if (latitude && longitude) {
                    const map = olaMaps.init({
                        style: "https://api.olamaps.io/tiles/vector/v1/styles/default-light-standard/style.json",
                        container: mapContainerId,
                        center: [longitude, latitude],
                        zoom: 15,
                    });
                    
                    // Add a marker with popup
                    const popup = olaMaps.addPopup({ offset: [0, -30], anchor: 'bottom' })
                        .setHTML('<div class="p-2"><strong>Delivery Location</strong><br>{{ request.address }}</div>');
                    
                    olaMaps.addMarker({
                        offset: [0, 6],
                        anchor: 'bottom',
                        color: 'red',
                        draggable: false,
                    })
                    .setLngLat([longitude, latitude])
                    .setPopup(popup)
                    .addTo(map);
                } else {
                    document.getElementById(mapContainerId).innerHTML = 
                        '<div class="d-flex justify-content-center align-items-center h-100 bg-light">' +
                        '<p class="text-muted">Location data not available</p>' +
                        '</div>';
                }
            }
        {% endfor %}
    });
</script>
{% endblock %}