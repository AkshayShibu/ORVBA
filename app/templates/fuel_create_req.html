{% extends 'fuel_home.html' %}
{% block fuel %}
{% load static %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
    body {
        background: radial-gradient(circle, rgb(248, 247, 247) 0%, rgb(76, 76, 77) 100%);
    }
    #map {
        height: 300px;
        margin-top: 20px;
        padding: 20px;
    }
</style>

<div class="container mt-5">
    <form class="form-control p-5 bg-white bg-opacity-50 mb-5" action="" method="post" id="requestForm" style="height:750px;">
        <div class="text-center my-3">
            <span class="h1 fw-bold" style="font-family: 'Times New Roman', serif;">Create Requests</span>
        </div>
        {% csrf_token %}
        {{form.errors}}
        <div class="row mt-4">
            <div class="col-2 mt-2">
                <label for="description">Description:</label>
            </div>
            <div class="col">
                <textarea name="discription" id="description" class="form-control" placeholder="Description" rows="6"></textarea>
            </div>
        </div>
        <input type="text" name="latitude" id="latitudeField" hidden>
        <input type="text" name="longtitude" id="longitudeField" hidden>
        <input type="text" name="address" id="addressField" hidden>
        <input type="text" name="link" id="linkField" hidden>
        <input type="text" name="location" value="{{mech.location.id}}" hidden>

        <!-- Map Section -->
        <div id="map"></div>
        <div class="mt-3">
            <strong>Live Location:</strong>
            <p>Address: <span id="address">Fetching...</span></p>
            <p>
                Shareable Link:
                <a id="share-link" href="#" target="_blank">Not available</a>
            </p>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-info text-white mt-3" style="font-family: 'Times New Roman', serif;">Send</button>
        </div>
    </form>
</div>

<script src="{% static 'OlaMapsWebSDKNew/olamaps-web-sdk.umd.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        if (typeof OlaMaps === "undefined") {
            console.error("Ola Maps SDK not loaded. Please check the script path.");
            return;
        }

        const olaMaps = new OlaMaps({
            apiKey: "JroyqW258sffaD9RtKwZECYJkKpbxrFUObU8R3Gy",
        });

        const myMap = olaMaps.init({
            style: "https://api.olamaps.io/tiles/vector/v1/styles/default-light-standard/style.json",
            container: "map",
            center: [77.61648476788898, 12.931423492103944],
            zoom: 15,
        });

        const geolocate = olaMaps.addGeolocateControls({
            positionOptions: {
                enableHighAccuracy: true,
            },
            trackUserLocation: true,
        });

        myMap.addControl(geolocate);

        async function fetchAddress(latitude, longitude) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.display_name || "Address not available";
            } catch (error) {
                console.error("Error fetching address:", error);
                return "Unable to fetch address.";
            }
        }

        geolocate.on("geolocate", async (event) => {
            const { latitude, longitude } = event.coords;
            myMap.setCenter([longitude, latitude]);

            const address = await fetchAddress(latitude, longitude);
            const link = `https://www.google.com/maps?q=${latitude},${longitude}`;

            document.getElementById("latitudeField").value = latitude;
            document.getElementById("longitudeField").value = longitude;
            document.getElementById("addressField").value = address;
            document.getElementById("linkField").value = link;

            document.getElementById("address").textContent = address;
            document.getElementById("share-link").href = link;
            document.getElementById("share-link").textContent = "Click here to share your location";
        });

        geolocate.on("error", (error) => {
            alert("Location access denied. Please enable location services.");
        });
    });
</script>
{% endblock %}
